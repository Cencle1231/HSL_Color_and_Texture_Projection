<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Geometric Pixel Pro - RGB Diff & Dithering</title>
    <style>
        :root { --primary: #a09dd8; --bg: #0f172a; --card: #1e293b; --border: #334155; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #f8fafc; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .panel { background: var(--card); padding: 24px; border-radius: 16px; width: 100%; max-width: 720px; display: grid; gap: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .label-row { display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; font-weight: bold; margin-bottom: 4px; }
        .palette-preview-container { background: #0f172a; padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
        .color-preview-bar { display: flex; height: 26px; border-radius: 4px; overflow: hidden; background: #000; }
        .swatch { flex: 1; height: 100%; border-right: 1px solid rgba(0,0,0,0.1); }
        .tab-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 6px; }
        .btn-palette { background: #334155; color: #cbd5e1; padding: 8px; border: 1px solid transparent; border-radius: 4px; font-size: 10px; cursor: pointer; text-align: left; }
        .btn-palette.active { background: var(--primary); color: white; border-color: #fff; }
        .control-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input[type="range"], select, input[type="color"] { background: #0f172a; border: 1px solid #475569; color: white; border-radius: 4px; padding: 8px; width: 100%; box-sizing: border-box; }
        input[type="color"] { height: 42px; padding: 2px; }
        .btn-main { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 14px; }
        .canvas-container { border: 4px solid #334155; border-radius: 8px; background: #111; margin-top: 10px; overflow: auto; max-width: 100%; }
        canvas { display: block; }
    </style>
</head>
<body>

    <h1 style="letter-spacing: 2px; font-size: 22px;">HALF <span style="color:var(--primary)">TONE</span> DOTS</h1>

    <div class="panel">
        <button class="btn-main" onclick="document.getElementById('upload').click()">UPLOAD IMAGE 导入图像</button>
        <input type="file" id="upload" hidden accept="image/*">

        <div class="palette-preview-container">
            <div class="label-row"><span>PALETTE PREVIEW 色板</span><span id="colorCount">Original</span></div>
            <div id="colorBar" class="color-preview-bar"></div>
        </div>

        <div id="colorContent" class="tab-content">
            <button class="btn-palette active" onclick="setPalette('none', this)">Original</button>
            <button class="btn-palette" onclick="setPalette('gb', this)">GameBoy</button>
            <button class="btn-palette" onclick="setPalette('gbc', this)">GameBoy Color</button>
            <button class="btn-palette" onclick="setPalette('sega', this)">Master System</button>
            <button class="btn-palette" onclick="setPalette('nes', this)">NES</button>
            <button class="btn-palette" onclick="setPalette('pico8', this)">PICO-8</button>
            <button class="btn-palette" onclick="setPalette('cga', this)">CGA Mode 4</button>
            <button class="btn-palette" onclick="setPalette('endesga32', this)">Endesga 32</button>
            <button class="btn-palette" onclick="setPalette('aap64', this)">AAP-64</button>
            <button class="btn-palette" onclick="setPalette('jmp16', this)">JMP-16</button>
            <button class="btn-palette" onclick="setPalette('sweetie16', this)">Sweetie 16</button>
            <button class="btn-palette" onclick="setPalette('solarized', this)">Solarized</button>
            <button class="btn-palette" onclick="setPalette('bw', this)">B&W</button>
        </div>

        <div class="control-row">
            <div class="slider-group">
                <label class="label-row">GRID 结构</label>
                <select id="gridShape" onchange="process()">
                    <option value="hexagon">Hexagonal (六边形)</option>
                    <option value="square">Square (正方形)</option>
                </select>
            </div>
            <div class="slider-group">
                <label class="label-row">背景与透明</label>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="color" id="bgColor" value="#000000" oninput="process()">
                    <label style="font-size:11px;"><input type="checkbox" id="transparentBg" onchange="process()"> 透明底</label>
                </div>
            </div>
        </div>

        <div class="control-row">
            <div class="slider-group">
                <div class="label-row"><span>步长 (Step)</span><b id="valStep">12</b></div>
                <input type="range" id="stepSize" min="4" max="100" value="12" oninput="process()">
            </div>
            <div class="slider-group">
                <div class="label-row"><span>点大小 (Scale)</span><b id="valScale">120%</b></div>
                <input type="range" id="dotScale" min="10" max="300" value="120" oninput="process()">
            </div>
        </div>

        <div class="control-row">
            <div class="slider-group">
                <div class="label-row"><span>RGB差异敏感度</span><b id="valContrast">1.5</b></div>
                <input type="range" id="contrast" min="0.1" max="5.0" step="0.1" value="1.5" oninput="process()">
            </div>
            <div class="slider-group">
                <div class="label-row"><span>颜色抖动强度</span><b id="valDither">0.5</b></div>
                <input type="range" id="ditherStrength" min="0" max="2" step="0.1" value="0.5" oninput="process()">
            </div>
        </div>

        <button class="btn-main" style="background:#4a5568" onclick="exportImg()">DOWNLOAD PNG (HIGH RES)</button>
    </div>

    <div class="canvas-container"><canvas id="canvas"></canvas></div>

    <script>
        const palettes = {
            gb: [[15, 56, 15], [48, 98, 48], [139, 172, 15], [155, 188, 15]],
            gbc: [[40, 40, 40], [104, 168, 16], [160, 184, 88], [200, 208, 160], [120, 128, 96], [48, 88, 144]],
            sega: [[0,0,0],[0,0,170],[0,170,0],[0,170,170],[170,0,0],[170,0,170],[170,85,0],[170,170,170],[85,85,85],[85,85,255],[85,255,85],[85,255,255],[255,85,85],[255,85,255],[255,255,85],[255,255,255]],
            nes: [[124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],[80,48,0],[0,120,0],[0,0,0],[252,252,252]],
            pico8: [[0,0,0],[29,43,83],[126,37,83],[0,135,81],[171,82,54],[95,87,79],[194,195,199],[255,241,232],[255,0,77],[255,163,0],[255,236,39],[0,228,54],[41,173,255],[131,118,156],[255,119,168],[255,204,170]],
            cga: [[0,0,0], [85,255,255], [255,85,255], [255,255,255]],
            endesga32: [[0,0,0], [27,28,51], [22,46,70], [30,76,103], [35,149,142], [82,233,113], [197,255,82], [255,236,103], [255,158,70], [230,72,46], [171,44,45], [121,58,128], [255,255,255]],
            aap64: [[6,6,8], [20,16,19], [37,24,28], [54,34,36], [75,45,45], [105,62,50], [130,81,54], [157,101,60], [187,131,74], [214,166,100], [238,206,145], [251,241,190], [202,227,255], [139,155,180], [101,101,118], [55,55,68]],
            jmp16: [[21,19,25], [44,36,51], [74,53,80], [116,77,112], [174,106,143], [225,142,176], [245,192,207], [253,234,239]],
            sweetie16: [[26,28,44],[93,39,93],[177,62,83],[239,125,87],[255,205,117],[167,240,112],[56,183,100],[37,113,121],[41,54,111],[59,93,201],[65,166,246],[115,239,247],[244,244,244],[148,176,194],[86,108,134],[51,60,87]],
            solarized: [[0,43,54],[7,54,66],[88,110,117],[101,123,131],[131,148,150],[147,161,161],[238,232,213],[253,246,227],[181,137,0],[203,75,22],[220,50,47],[211,54,130],[108,113,196],[38,139,210],[42,161,152],[133,153,0]],
            bw: [[0,0,0], [255,255,255]]
        };

        const bayer4x4 = [
            [0, 8, 2, 10], [12, 4, 14, 6], [3, 11, 1, 9], [15, 7, 13, 5]
        ];

        let originalImg = null, activePalKey = 'none';

        function setPalette(k, b) {
            activePalKey = k;
            document.querySelectorAll('.btn-palette').forEach(btn => btn.classList.remove('active'));
            b.classList.add('active'); updateColorStrip(); process();
        }

        function updateColorStrip() {
            const bar = document.getElementById('colorBar'); bar.innerHTML = '';
            if (activePalKey === 'none') { bar.style.background = "linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00)"; return; }
            bar.style.background = 'none';
            palettes[activePalKey].forEach(c => {
                const s = document.createElement('div'); s.className = 'swatch';
                s.style.backgroundColor = `rgb(${c[0]},${c[1]},${c[2]})`; bar.appendChild(s);
            });
        }

        upload.onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => { originalImg = new Image(); originalImg.onload = process; originalImg.src = ev.target.result; };
            reader.readAsDataURL(e.target.files[0]);
        };

        function process() {
            if (!originalImg) return;
            const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
            const step = parseInt(document.getElementById('stepSize').value), scale = parseInt(document.getElementById('dotScale').value)/100;
            const shape = document.getElementById('gridShape').value, bg = document.getElementById('bgColor').value;
            const contrast = parseFloat(document.getElementById('contrast').value), dither = parseFloat(document.getElementById('ditherStrength').value);
            const isTrans = document.getElementById('transparentBg').checked;

            document.getElementById('valStep').innerText = step;
            document.getElementById('valScale').innerText = Math.round(scale*100) + '%';
            document.getElementById('valContrast').innerText = contrast.toFixed(1);
            document.getElementById('valDither').innerText = dither.toFixed(1);

            canvas.width = originalImg.width; canvas.height = originalImg.height;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if(!isTrans) { ctx.fillStyle = bg; ctx.fillRect(0,0,canvas.width,canvas.height); }

            const tempC = document.createElement('canvas'); tempC.width = canvas.width; tempC.height = canvas.height;
            const tCtx = tempC.getContext('2d'); tCtx.drawImage(originalImg, 0, 0);
            const imgData = tCtx.getImageData(0,0,canvas.width,canvas.height).data;

            const rB = parseInt(bg.slice(1,3),16), gB = parseInt(bg.slice(3,5),16), bB = parseInt(bg.slice(5,7),16);
            const rowH = (shape === 'hexagon') ? step * 0.866 : step;

            for (let y=0; y<canvas.height+step; y+=rowH) {
                const rIdx = Math.round(y/rowH), xO = (shape === 'hexagon' && rIdx%2!==0) ? step/2 : 0;
                for (let x=-step; x<canvas.width+step; x+=step) {
                    const px = Math.min(canvas.width-1, Math.max(0, Math.round(x+xO))), py = Math.min(canvas.height-1, Math.max(0, Math.round(y)));
                    const i = (py*canvas.width + px)*4;
                    
                    // 1. 获取基础色彩并应用抖动偏移
                    let r = imgData[i], g = imgData[i+1], b = imgData[i+2];
                    const dVal = (bayer4x4[py%4][px%4] - 8) * dither * 10;
                    const dr = r+dVal, dg = g+dVal, db = b+dVal;

                    // 2. RGB 欧式距离计算差值 (0.0 - 1.0)
                    // 使用平方根计算三维空间距离，差异最大为 sqrt(255^2 * 3)
                    const dist = Math.sqrt((r-rB)**2 + (g-gB)**2 + (b-bB)**2) / 441.67;
                    const diff = Math.pow(dist, contrast);

                    // 3. 色板映射 (对抖动后的颜色进行映射)
                    if(activePalKey !== 'none') {
                        let minD = Infinity, best = palettes[activePalKey][0];
                        for(const c of palettes[activePalKey]) {
                            const d = (dr-c[0])**2 + (dg-c[1])**2 + (db-c[2])**2;
                            if(d < minD) { minD = d; best = c; }
                        }
                        [r,g,b] = best;
                    }

                    // 4. 绘图
                    const rad = (step/2) * diff * scale;
                    if(rad > 0.1) {
                        ctx.fillStyle = `rgb(${r},${g},${b})`;
                        ctx.beginPath();
                        ctx.arc(x+xO, y, rad, 0, Math.PI*2);
                        ctx.fill();
                    }
                }
            }
        }

        function exportImg() {
            if(!originalImg) return;
            const link = document.createElement('a');
            link.download = `pixel-lab-export-${Date.now()}.png`;
            link.href = document.getElementById('canvas').toDataURL("image/png");
            link.click();
        }
        updateColorStrip();
    </script>
</body>
</html>