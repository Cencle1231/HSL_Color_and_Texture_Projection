<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berry Mix</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --card: #1a1a1a;
            --gray: #2a2a2a;
            --accent: #fff;
            --text: #888;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 0;
            background: var(--bg);
            font-family: -apple-system, sans-serif;
            color: #eee;
        }

        /* 找到 .canvas-container，修改 background */
        .canvas-container {
            width: 100%;
            max-width: 400px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            /* 修改这里：添加棋盘格图案 */
            background-image: linear-gradient(45deg, #222 25%, transparent 25%),
                linear-gradient(-45deg, #222 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #222 75%),
                linear-gradient(-45deg, transparent 75%, #222 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #111;
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto;
            max-height: 65vh;
            object-fit: contain;
        }

        .tabs {
            display: flex;
            width: 100%;
            max-width: 400px;
            margin-top: 15px;
            gap: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: var(--card);
            border: 1px solid #222;
            color: var(--text);
            border-radius: 10px 10px 0 0;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
        }

        .tab-btn.active {
            background: var(--gray);
            color: #fff;
            border-bottom: 2px solid #fff;
        }

        .panel {
            width: 100%;
            max-width: 400px;
            background: var(--gray);
            padding: 15px;
            box-sizing: border-box;
            border-radius: 0 0 12px 12px;
            display: none;
            flex-direction: column;
            gap: 12px;
        }

        .panel.active {
            display: flex;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #aaa;
            text-transform: uppercase;
        }

        select,
        input[type=range] {
            width: 100%;
            outline: none;
        }

        select {
            background: #333;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        input[type=range] {
            -webkit-appearance: none;
            height: 3px;
            background: #444;
            border-radius: 2px;
            margin: 10px 0;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #999;
            border-radius: 50%;
            border: 2px solid #333;
            cursor: pointer;
        }

        .btn-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin-top: 15px;
            padding-bottom: 30px;
        }

        button.action {
            padding: 18px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-gen {
            background: #fff;
            color: #000;
        }

        .btn-exp {
            background: #333;
            color: #fff;
        }
    </style>
</head>

<body>

    <div class="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <div class="tabs">
        <div class="tab-btn active" onclick="showTab('color')">Color</div>
        <div class="tab-btn" onclick="showTab('shape')">Shape</div>
        <div class="tab-btn" onclick="showTab('style')">Style</div>
    </div>

    <div id="colorPanel" class="panel active">
        <div class="control-group">
            <div class="label-row">Background Mode</div>
            <select id="bgMode">
                <option value="deep">Deep Hue</option>
                <option value="pure">Pure Black</option>
                <option value="white">Soft White</option>
                <option value="sand">Warm Sand</option>
                <option value="navy">Midnight Navy</option>
                <option value="transparent">Transparent (PNG)</option>
            </select>
            </select>
        </div>
        <div class="control-group">
            <div class="label-row">Color Mode & Base Hue</div>
            <select id="colorMode">
                <option value="random">Full Random</option>
                <option value="analogous" selected>Analogous</option>
                <option value="complementary">Complementary</option>
            </select>
            <input type="range" id="baseHue" min="0" max="360" value="210">
        </div>
        <div class="control-group">
            <div class="label-row">Avg Sat / Bri</div>
            <input type="range" id="satAvg" min="0" max="100" value="65">
            <input type="range" id="lightAvg" min="10" max="90" value="50">
        </div>
        <div class="control-group">
            <div class="label-row">Contrast Gap (S/L)</div>
            <input type="range" id="satGap" min="0" max="50" value="20">
            <input type="range" id="lightGap" min="0" max="50" value="25">
        </div>
    </div>

    <div id="shapePanel" class="panel">
        <div class="control-group">
            <div class="label-row">Canvas Ratio</div>
            <select id="aspectRatio">
                <option value="wallpaper" selected>Phone (9:16)</option>
                <option value="mac">Laptop (16:10)</option>
                <option value="ultrawide">Ultrawide (21:9)</option>
                <option value="square">Square (1:1)</option>
            </select>
        </div>
        <div class="control-group">
            <div class="label-row">Shape Type & Overlap</div>
            <select id="shapeType">
                <option value="circle">Circle</option>
                <option value="rect">Rounded Square</option>
                <option value="star4">Four-Point Star</option>
                <option value="star5">Five-Point Star</option>
                <option value="mix">Mixed All</option>
            </select>
            <input type="range" id="overlapAmount" min="0" max="100" value="20">
        </div>
    </div>

    <div id="stylePanel" class="panel">
        <div class="control-group">
            <div class="label-row">Blur Intensity</div>
            <input type="range" id="blurAmount" min="0" max="250" value="80">
        </div>
        <div class="control-group">
            <div class="label-row">Frosted Grain</div>
            <input type="range" id="grainAmount" min="0" max="100" value="35">
        </div>
        <div class="control-group">
    <div class="label-row">
        <span>Shape Opacity</span>
        <span id="opacityVal">0.6</span>
    </div>
    <input type="range" id="shapeOpacity" min="0.1" max="1.0" step="0.05" value="0.6">
</div>
    </div>

    <div class="btn-row">
        <button class="action btn-gen" onclick="render(true)">Generate</button>
        <button class="action btn-exp" onclick="showExport()">Export</button>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');
        let shapes = [];

        function showTab(name) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name + 'Panel').classList.add('active');
            event.target.classList.add('active');
        }

        const getVal = id => document.getElementById(id).value;

        function updateCanvasSize() {
            const ratio = getVal('aspectRatio');
            canvas.width = 1000;
            if (ratio === 'wallpaper') canvas.height = 1777;
            else if (ratio === 'mac') canvas.height = 625;
            else if (ratio === 'ultrawide') canvas.height = 428;
            else canvas.height = 1000;
        }

        function calculate() {
            updateCanvasSize();
            const mode = getVal('colorMode'), bH = +getVal('baseHue'), sA = +getVal('satAvg'), lA = +getVal('lightAvg'), sG = +getVal('satGap'), lG = +getVal('lightGap'), overlap = +getVal('overlapAmount');

            shapes = [];
            const radii = [480, 420, 360, 300, 240, 180, 150];

            radii.forEach((r, i) => {
                let h;
                if (mode === 'random') h = Math.random() * 360;
                else if (mode === 'complementary') h = i % 2 === 0 ? bH : (bH + 180) % 360;
                else h = (bH + (i - 3) * 15 + 360) % 360; // Analogous logic

                const s = Math.max(0, Math.min(100, sA + (Math.random() - 0.5) * sG * 2));
                const l = Math.max(0, Math.min(100, lA + (Math.random() - 0.5) * lG * 2));

                let x, y, found = false;
                for (let t = 0; t < 50; t++) {
                    x = Math.random() * canvas.width; y = Math.random() * canvas.height;
                    if (!shapes.some(o => Math.hypot(x - o.x, y - o.y) < (r + o.r) * (1 - overlap / 100))) { found = true; break; }
                }
                const allTypes = ['circle', 'rect', 'star4', 'star5'];
                const st = getVal('shapeType') === 'mix'
                    ? allTypes[Math.floor(Math.random() * allTypes.length)]
                    : getVal('shapeType'); shapes.push({ x: found ? x : Math.random() * canvas.width, y: found ? y : Math.random() * canvas.height, r, c: `hsl(${h},${s}%,${l}%)`, type: st });
            });
        }

        function render(regen = false) {
            if (regen) calculate();
            const bM = getVal('bgMode'), bH = +getVal('baseHue');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. 背景层
            if (bM === 'transparent') {
                // 如果是透明模式，清空画布且不填充任何颜色
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            } else {
                // 原有的颜色逻辑
                if (bM === 'deep') ctx.fillStyle = `hsl(${bH},20%,7%)`;
                else if (bM === 'pure') ctx.fillStyle = '#050505';
                else if (bM === 'white') ctx.fillStyle = '#f8f8f8';
                else if (bM === 'sand') ctx.fillStyle = '#e5ddd3';
                else ctx.fillStyle = '#0a1628';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // 2. 形状层
            ctx.filter = `blur(${getVal('blurAmount')}px)`;
            shapes.forEach(s => {
                ctx.beginPath();
                ctx.fillStyle = s.c;

                if (s.type === 'circle') {
                    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
                }
                else if (s.type === 'rect') {
                    ctx.roundRect(s.x - s.r, s.y - s.r, s.r * 2, s.r * 2, s.r * 0.4);
                }
                // --- 这里是新增的星形判断逻辑 ---
                else if (s.type === 'star4' || s.type === 'star5') {
                    const points = s.type === 'star4' ? 4 : 5;
                    const outerRadius = s.r;
                    const innerRadius = s.r * 0.45; // 这个数值决定了星星的“瘦”程度
                    let angle = Math.PI / points;

                    for (let i = 0; i < 2 * points; i++) {
                        let radius = i % 2 === 0 ? outerRadius : innerRadius;
                        // 减去 Math.PI / 2 是为了让星星尖角朝上
                        let currX = s.x + Math.cos(i * angle - Math.PI / 2) * radius;
                        let currY = s.y + Math.sin(i * angle - Math.PI / 2) * radius;
                        if (i === 0) ctx.moveTo(currX, currY);
                        else ctx.lineTo(currX, currY);
                    }
                    ctx.closePath();
                }
                // ----------------------------
                ctx.fill();
            });
            ctx.filter = 'none';

            // 3. 像素级磨砂处理
            const g = +getVal('grainAmount');
            if (g > 0) {
                const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imgData.data;
                const noiseIntensity = g * 0.45;
                for (let i = 0; i < data.length; i += 4) {
                    const noise = (Math.random() - 0.5) * noiseIntensity;
                    data[i] += noise; data[i + 1] += noise; data[i + 2] += noise;
                }
                ctx.putImageData(imgData, 0, 0);
            }
        }

        function showExport() {
            render();
            const link = document.createElement('a');
            link.download = 'frosted-wallpaper.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        document.querySelectorAll('input, select').forEach(el => {
            el.oninput = () => render(el.id !== 'blurAmount' && el.id !== 'grainAmount');
        });

        render(true);
    </script>
</body>

</html>