<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riso Depart</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #e2dfd8;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: sans-serif;
            padding: 20px;
            color: #333;
        }

        .controls {
            width: 100%;
            max-width: 1250px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .layers-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 12px;
        }

        .layer-box {
            padding: 12px;
            border-radius: 8px;
            background: #fafafa;
            border: 1px solid #ddd;
            transition: 0.2s;
            position: relative;
        }

        .layer-box.disabled {
            opacity: 0.35;
            background: #eee;
        }

        .layer-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            font-size: 13px;
        }

        .ctrl-group {
            margin-bottom: 8px;
            font-size: 11px;
        }

        .ctrl-group label {
            display: block;
            color: #777;
            margin-bottom: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .slider-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        select,
        input[type="range"] {
            width: 100%;
            cursor: pointer;
            height: 24px;
        }

        .canvas-area {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        button {
            background: #333;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #000;
        }
    </style>
</head>

<body>

    <div class="controls">
        <div class="wide-slider-container">
    <label style="font-size: 13px; font-weight: bold;">纸张背景:</label>
    <input type="color" id="bgColorIn" value="#f2eee5" style="width:40px; height:30px; border:none; cursor:pointer; background:none;">
</div>
        <div class="top-bar">
            <div>
                <input type="file" id="imgInput" accept="image/*">
                <span style="font-size: 12px; margin-left:15px">网点密度: <input type="range" id="gridIn" min="2" max="18"
                        value="6" style="width:500px; vertical-align:middle"></span>
            </div>
<div style="display: flex; gap: 8px; align-items: center;">
    <button onclick="saveCanvas('riso_art_ryb','png')">导出作品</button>
    <select id="presetList" style="width:120px; height:32px; font-size:12px; border:1px solid #ccc; border-radius:4px; background:#fff;">
        <option value="">-- 我的预设 --</option>
    </select>
    <button onclick="saveNewPreset()" style="background: #666; padding: 5px 12px; font-size:12px;">保存</button>
    <button onclick="deletePreset()" style="background: #666; padding: 5px 12px; font-size:12px;">删除</button>
    <button onclick="downloadPresetFile()" style="background: #333; padding: 5px 12px; font-size:12px;">导出JSON</button>
    <button onclick="document.getElementById('presetInput').click()" style="background: #333; padding: 5px 12px; font-size:12px;">导入JSON</button>
    <input type="file" id="presetInput" accept=".json" style="display:none">
    <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
    
</div>            
        </div>

        <div class="layers-container" id="layersHost">
            <script>
                const risoColors = `
    /* 荧光及高亮系列 */
    <optgroup label="荧光及高亮系列 (Fluorescent)">
    <option value="#ff48b0">Fluorescent Pink (荧光粉)</option>
    <option value="#fff000">Fluorescent Yellow (荧光黄)</option>
    <option value="#ffb000">Fluorescent Orange (荧光橙)</option>
    <option value="#00FF00">Fluorescent Green (荧光绿)</option>
    <option value="#1AF4FF">Fluorescent Blue (荧光青)</option>
    <option value="#FF355E">Fluorescent Red (荧光红/极光红)</option> 
    <option value="#BD00FF">Electric Violet (荧光紫/电子紫)</option> 
<option value="#0045FF">International Klein Blue (克莱因蓝)</option>
    </optgroup>

    /* 暖色及经典系列 */
    <optgroup label="暖色及经典系列 (Warm)">
    <option value="#FF7300">Bright Orange (亮橘)</option>
    <option value="#ff6c2f">Bright Red (鲜红)</option>
    <option value="#ffe800">Yellow (黄)</option>
    <option value="#b1905a">Copper / Gold (金属铜金)</option>
    <option value="#6e1e2d">Burgundy (酒红)</option>
    </optgroup>

    
    /* 冷色系列 */
    <optgroup label="冷色系列 (Cool)">
    <option value="#82d8d5">Mint (薄荷绿)</option>
    <option value="#00a95c">Green (绿)</option>
    <option value="#005d43">Hunter Green (猎人绿)</option>
    <option value="#00838a">Teal (青色)</option>
    <option value="#40c1ff">Sky Blue (天蓝)</option>
    <option value="#6488ea">Cornflower (矢车菊蓝)</option>
    <option value="#0078bf">Risofederal Blue (联邦蓝)</option>
        <option value="#765ba7">Purple (紫色)</option>
    <option value="#665780">Grape (葡萄紫)</option>
    </optgroup>

       /* 基础系列 */
       <optgroup label="基础系列 (Base)">
    <option value="#000000" >Black (黑)</option>
    <option value="#451910" >Choco (巧克力色)</option>
    <option value="#ffffff">White (纯白)</option>
</optgroup>

    /* 复古系列 */
    <optgroup label="复古系列 (Vintage)">
    <option value="#f5a18d">Apricot (杏黄 - 肤色)</option>
<option value="#5f8289">Smoky Teal (烟熏青 - 灰)</option>
<option value="#e5483f">Crimson (深红 - 复古海报)</option>
<option value="#bb8b41">Flat Gold (哑光金 - 绘本风)</option>
</optgroup>

<optgroup label="清新粉彩系列 (Pastel Complete)">
        <option value="#fdf2c4">Eggshell (蛋壳黄 - 奶油色/极浅黄)</option>
        <option value="#ffda52">Sunflower (向日葵黄 - 暖亮黄)</option>
        <option value="#ffd1dc">Shell Pink (贝壳粉 - 极浅暖粉)</option>
        <option value="#fb867e">Coral (珊瑚粉 - 甜美轻盈)</option>
        <option value="#e9d1b0">Pale Ochre (淡赭 - 奶茶色/低饱和暖)</option>
        <option value="#8bc53f">Melon (哈密瓜绿 - 生机勃勃)</option>
        <option value="#b2c2a2">Sage (鼠尾草绿 - 莫兰迪豆沙绿)</option>
        <option value="#5ec7e0">Aqua (水蓝色 - 清透凉爽)</option>
        <option value="#a1caf1">Dusty Blue (灰蓝色 - 极简灰蓝)</option>
        <option value="#d6b4fc">Soft Violet (薰衣草 - 柔和优雅)</option>
        <option value="#d1b3d1">Mauve (葵紫 - 复古灰紫)</option>
        <option value="#8a8985">Light Grey (浅灰色 - 高级过渡)</option>
    </optgroup>
    
`;

                for (let i = 1; i <= 6; i++) {
                    document.write(`
                    <div class="layer-box ${i > 1 ? 'disabled' : ''}" id="box${i}">
                        <div class="layer-header">
                            <input type="checkbox" id="en${i}" ${i === 1 ? 'checked' : ''}>
                            <span>图层通道 ${i}</span>
 <select id="m${i}" style="width:auto; margin-left:auto; font-size:10px">
    <option value="BLEND">智能叠加 (Smart Blend)</option>
    <option value="MULTIPLY">经典正片叠底</option>
    <option value="COLOR_BURN">经典颜色加深</option>
    <option value="SCREEN">经典滤色 (发光)</option> </select>
                        </div>
                        <div class="ctrl-group">
    <label>旋转角度 (Angle) & 压力变形</label>
    <div class="slider-row">
        Rot: <input type="range" id="rot${i}" min="0" max="90" step="15" value="0" style="width:60%">
        Def: <input type="range" id="def${i}" min="0.8" max="1.0" step="0.01" value="1" style="width:40%">
    </div>
</div>
                        <div class="ctrl-group">
                            <label>油墨与透明度</label>
                            <div class="slider-row">
                                <select id="c${i}">${risoColors}</select>
                                <input type="range" id="a${i}" min="0" max="255" value="230">
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <label>RYB 逻辑提取 / 网点倍率</label>
                            <div class="slider-row">
                                <select id="ch${i}">
    <optgroup label="艺术分色 (RYB)">
        <option value="art_red">红色 (Red)</option>
        <option value="art_yellow">黄色 (Yellow)</option>
        <option value="art_blue">蓝色 (Blue)</option>
        <option value="art_orange">橙色 (Orange)</option>
        <option value="art_green">绿色 (Green)</option>
        <option value="art_purple">紫色 (Purple)</option>
    </optgroup>
    <optgroup label="印刷分色 (CMYK)">
        <option value="cmyk_c">青色通道 (Cyan)</option>
        <option value="cmyk_m">品色通道 (Magenta)</option>
        <option value="cmyk_y">黄色通道 (Yellow)</option>
        <option value="cmyk_k">黑色通道 (Key/Black)</option>
    </optgroup>
    <optgroup label="光影通道">
        <option value="dark">深色阴影 </option>
        <option value="light">浅色亮部</option>
    </optgroup>
    <optgroup label="橙色分色">
    <option value="orange_red">红相橙 (暖橙)</option>
    <option value="orange_yellow">黄相橙 (亮橙)</option>
</optgroup>
<optgroup label="绿色分色">
    <option value="green_yellow">黄相绿 (嫩绿)</option>
    <option value="green_blue">蓝相绿 (青绿)</option>
</optgroup>
<optgroup label="紫色分色">
    <option value="purple_red">红相紫 (品紫)</option>
    <option value="purple_blue">蓝相紫 (冷紫)</option>
</optgroup>

</select>
                                <input type="range" id="s${i}" min="0.2" max="3.0" step="0.1" value="0.8">
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <label>容差 & 偏移</label>
                            <div class="slider-row">
                                <input type="range" id="t${i}" min="0" max="200" value="60">
                            </div>
                            <div class="slider-row" style="margin-top:5px">
                                X:<input type="range" id="x${i}" min="-15" max="15" value="0">
                                Y:<input type="range" id="y${i}" min="-15" max="15" value="0">
                            </div>
                        </div>
                    </div>
                `);
                }
            </script>
        </div>
    </div>

    <div class="canvas-area" id="p5-holder"></div>

    <script>
        let img;
        let cachedData = [];
        let imgW = 0, imgH = 0;
        let pg;

        function setup() {
            const cnv = createCanvas(600, 600);
            cnv.parent('p5-holder');
            pg = createGraphics(600, 600);
            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', (e) => {
                    if (e.target.id.startsWith('en')) {
                        const id = e.target.id.replace('en', '');
                        document.getElementById('box' + id).classList.toggle('disabled', !e.target.checked);
                    }
                    loop();
                });
            });
document.getElementById('imgInput').addEventListener('change', handleFile);

            // 新增：预设下拉菜单监听
            document.getElementById('presetList').addEventListener('change', (e) => {
                const name = e.target.value;
                const library = JSON.parse(localStorage.getItem('risoLibrary') || '{}');
                if (library[name]) {
                    applyDataToUI(library[name]);
                    loop();
                }
            });
            // 新增：文件导入监听
            document.getElementById('presetInput').addEventListener('change', handleImport);
            // 初始化刷新菜单
            updatePresetMenu();            
            noLoop();
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                loadImage(event.target.result, loadedImg => {
                    if (loadedImg.width > 500) loadedImg.resize(500, 0);
                    img = loadedImg;
                    img.loadPixels();
                    imgW = img.width; imgH = img.height;
                    cachedData = [];
                    for (let i = 0; i < img.pixels.length; i += 4) {
                        cachedData.push({ r: img.pixels[i], g: img.pixels[i + 1], b: img.pixels[i + 2] });
                    }
                    const finalH = 750 * (imgH / imgW);
                    resizeCanvas(750, finalH);
                    pg = createGraphics(750, finalH);
                    loop();
                });
            };
            reader.readAsDataURL(file);
        }

        function draw() {
// 获取用户选择的背景色
    const bgCol = document.getElementById('bgColorIn').value;
    background(bgCol);
            if (!img) return;
            push(); stroke(0, 10);
            for (let i = 0; i < 6000; i++) point(random(width), random(height));
            pop();
            const globalGrid = parseInt(document.getElementById('gridIn').value);
            for (let i = 1; i <= 6; i++) {
                if (document.getElementById('en' + i).checked) renderSmartLayer(i, globalGrid);
            }
            noLoop();
        }

        function renderSmartLayer(idx, dSize) {
            const blendKey = document.getElementById('m' + idx).value;
            const baseCol = color(document.getElementById('c' + idx).value);
            const alphaVal = float(document.getElementById('a' + idx).value);
            const angle = float(document.getElementById('rot' + idx).value);
const deform = float(document.getElementById('def' + idx).value);
            pg.clear();
            pg.fill(red(baseCol), green(baseCol), blue(baseCol), alphaVal);
            pg.noStroke();

            const offX = float(document.getElementById('x' + idx).value);
            const offY = float(document.getElementById('y' + idx).value);
            const modeKey = document.getElementById('ch' + idx).value;
            const dotScale = float(document.getElementById('s' + idx).value);
            const tolerance = float(document.getElementById('t' + idx).value);

            for (let y = 0; y < imgH; y++) {
                for (let x = 0; x < imgW; x++) {
                    if (x % Math.floor(dSize / 2) === 0 && y % Math.floor(dSize / 2) === 0) {
                        const p = cachedData[y * imgW + x];
                        let strength = 0;

                        // RYB 艺术家分色算法
                        switch (modeKey) {
                            case 'art_red': strength = p.r - (p.g + p.b) / 2; break;
                            case 'art_yellow': strength = (p.r + p.g) / 2 - p.b; break;
                            case 'art_blue': strength = p.b - (p.r + p.g) / 2; break;
                            case 'art_orange': strength = p.r * 0.8 + p.g * 0.4 - p.b; break;
                            case 'art_green': strength = p.g - (p.r + p.b) / 2; break;
                            case 'art_purple': strength = (p.r + p.b) / 2 - p.g; break;
                            case 'cmyk_c':
                                strength = 255 - p.r;
                                break;
                            case 'cmyk_m':
                                strength = 255 - p.g;
                                break;
                            case 'cmyk_y':
                                strength = 255 - p.b;
                                break;
                            case 'cmyk_k':
                                strength = 255 - max(p.r, max(p.g, p.b));
                                break;
                            case 'dark': strength = 255 - (p.r + p.g + p.b) / 3; break;
                            case 'light': strength = (p.r + p.g + p.b) / 3 - 128; break;
                            
                            // --- 橙色系 ---
    case 'orange_red': strength = p.r - p.b; break;
    case 'orange_yellow': strength = (p.r + p.g)/2 - p.b; break;
    
    // --- 绿色系 ---
    case 'green_yellow': strength = p.g - p.b; break;
    case 'green_blue': strength = (p.g + p.b)/2 - p.r; break;
    
    // --- 紫色系 ---
    case 'purple_red': strength = (p.r + p.b)/2 - p.g * 0.8; break;
    case 'purple_blue': strength = p.b - p.g; break;
                        }

                        const finalS = map(strength, 0, 255 - tolerance, 0, 255);
                        const radius = map(constrain(finalS, 0, 255), 0, 200, 0, dSize * dotScale);
if (radius > 0.4) {
    // 只有当角度不是 0 且变形不是 1 时才使用坐标变换，否则直接画圆
    if (angle === 0 && deform === 1.0) {
        pg.ellipse(map(x, 0, imgW, 0, width) + offX, map(y, 0, imgH, 0, height) + offY, radius);
    } else {
        pg.push();
        let drawX = map(x, 0, imgW, 0, width) + offX;
        let drawY = map(y, 0, imgH, 0, height) + offY;
        pg.translate(drawX, drawY);
        pg.rotate(radians(angle));
        pg.ellipse(0, 0, radius, radius * deform);
        pg.pop();
    }
}
                    }
                }
            }
// 在 renderLayer 函数末尾的混合逻辑处修改
// --- renderSmartLayer 函数末尾 ---
push(); 

const userBlendMode = document.getElementById('m' + idx).value; // 获取下拉框的值
const inkColor = document.getElementById('c' + idx).value.toLowerCase(); // 获取油墨颜色

if (userBlendMode === 'BLEND') {
    // 只有在“智能叠加”模式下，才根据颜色自动判断
    if (inkColor === '#ffffff' ) {
        blendMode(SCREEN); 
    } else {
        blendMode(MULTIPLY); 
    }
} else {
    // 如果用户选了具体模式（正片叠底/颜色加深/滤色），则强制执行
    // 这里的 eval 会直接把字符串 "COLOR_BURN" 转成 p5 内部的常量 COLOR_BURN
    try {
        blendMode(eval(userBlendMode)); 
    } catch (e) {
        blendMode(MULTIPLY); // 万一出错，回退到最稳的正片叠底
    }
}

image(pg, 0, 0); 
pop(); 

// 这一行极其重要：强制重置全局状态，否则下一层渲染会乱码
blendMode(BLEND);
        }
        // --- 预设管理核心逻辑 ---

        // 刷新下拉列表
        function updatePresetMenu() {
            const menu = document.getElementById('presetList');
            const library = JSON.parse(localStorage.getItem('risoLibrary') || '{}');
            menu.innerHTML = '<option value="">-- 我的预设 --</option>';
            for (let name in library) {
                let opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                menu.appendChild(opt);
            }
        }

        // 保存当前参数到列表
        function saveNewPreset() {
            let name = prompt("给预设起个名字:", "新风格 " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
            if (!name) return;
            const library = JSON.parse(localStorage.getItem('risoLibrary') || '{}');
            library[name] = packUIData();
            localStorage.setItem('risoLibrary', JSON.stringify(library));
            updatePresetMenu();
            document.getElementById('presetList').value = name;
        }

        // 核心：打包 UI 数据
        function packUIData() {
            let data = {
                gridSize: document.getElementById('gridIn').value,
                bgColor: document.getElementById('bgColorIn').value,
                layers: []
            };
            for (let i = 1; i <= 6; i++) {
                data.layers.push({
                    en: document.getElementById('en' + i).checked,
                    m: document.getElementById('m' + i).value,
                    c: document.getElementById('c' + i).value,
                    a: document.getElementById('a' + i).value,
                    ch: document.getElementById('ch' + i).value,
                    s: document.getElementById('s' + i).value,
                    t: document.getElementById('t' + i).value,
                    x: document.getElementById('x' + i).value,
                    y: document.getElementById('y' + i).value,
                    rot: document.getElementById('rot' + i).value,
                    def: document.getElementById('def' + i).value
                });
            }
            return data;
        }

        // 核心：将数据还原到 UI
        function applyDataToUI(data) {
            document.getElementById('gridIn').value = data.gridSize;
            if(data.bgColor) document.getElementById('bgColorIn').value = data.bgColor;
            data.layers.forEach((l, idx) => {
                let i = idx + 1;
                document.getElementById('en' + i).checked = l.en;
                document.getElementById('m' + i).value = l.m;
                document.getElementById('c' + i).value = l.c;
                document.getElementById('a' + i).value = l.a;
                document.getElementById('ch' + i).value = l.ch;
                document.getElementById('s' + i).value = l.s;
                document.getElementById('t' + i).value = l.t;
                document.getElementById('x' + i).value = l.x;
                document.getElementById('y' + i).value = l.y;
                if(document.getElementById('rot'+i)) document.getElementById('rot'+i).value = l.rot || 0;
                if(document.getElementById('def'+i)) document.getElementById('def'+i).value = l.def || 1;
                document.getElementById('box' + i).classList.toggle('disabled', !l.en);
            });
        }

        // 删除选中的预设
        function deletePreset() {
            const name = document.getElementById('presetList').value;
            if (!name) return;
            if (confirm(`确定要删除 "${name}" 吗？`)) {
                const library = JSON.parse(localStorage.getItem('risoLibrary') || '{}');
                delete library[name];
                localStorage.setItem('risoLibrary', JSON.stringify(library));
                updatePresetMenu();
            }
        }

        // 导出 JSON 文件
        function downloadPresetFile() {
            const name = document.getElementById('presetList').value;
            if (!name) { alert("请先选择一个预设"); return; }
            const library = JSON.parse(localStorage.getItem('risoLibrary') || '{}');
            const blob = new Blob([JSON.stringify(library[name], null, 2)], {type: "application/json"});
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `riso_${name}.json`;
            a.click();
        }

        // 导入 JSON 文件
        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    applyDataToUI(data);
                    alert("已加载外部参数，点“保存”可存入列表");
                    loop();
                } catch(err) { alert("文件解析错误"); }
            };
            reader.readAsText(file);
        }
    </script>
</body>

</html>
