<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riso Depart</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #e2dfd8;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: sans-serif;
            padding: 20px;
            color: #333;
        }

        .controls {
            width: 100%;
            max-width: 1250px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }

        .layers-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 12px;
        }

        .layer-box {
            padding: 12px;
            border-radius: 8px;
            background: #fafafa;
            border: 1px solid #ddd;
            transition: 0.2s;
            position: relative;
        }

        .layer-box.disabled {
            opacity: 0.35;
            background: #eee;
        }

        .layer-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            font-size: 13px;
        }

        .ctrl-group {
            margin-bottom: 8px;
            font-size: 11px;
        }

        .ctrl-group label {
            display: block;
            color: #777;
            margin-bottom: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .slider-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        select,
        input[type="range"] {
            width: 100%;
            cursor: pointer;
            height: 24px;
        }

        .canvas-area {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
        }

        button {
            background: #333;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            background: #000;
        }
    </style>
</head>

<body>

    <div class="controls">
        <div class="wide-slider-container">
    <label style="font-size: 13px; font-weight: bold;">纸张背景:</label>
    <input type="color" id="bgColorIn" value="#f2eee5" style="width:40px; height:30px; border:none; cursor:pointer; background:none;">
</div>
        <div class="top-bar">
            <div>
                <input type="file" id="imgInput" accept="image/*">
                <span style="font-size: 12px; margin-left:15px">网点密度: <input type="range" id="gridIn" min="2" max="18"
                        value="6" style="width:500px; vertical-align:middle"></span>
            </div>
            <button onclick="saveCanvas('riso_art_ryb','png')">导出作品</button>
        </div>

        <div class="layers-container" id="layersHost">
            <script>
                const risoColors = `
    /* 荧光及高亮系列 */
    <option value="#ff48b0">Fluorescent Pink (荧光粉)</option>
    <option value="#fff000">Fluorescent Yellow (荧光黄)</option>
    <option value="#ffb000">Fluorescent Orange (荧光橙)</option>
    <option value="#00FF00">Fluorescent Green (荧光绿)</option>
    <option value="#1AF4FF">Fluorescent Blue (荧光青)</option>
    <option value="#FF355E">Fluorescent Red (荧光红/极光红)</option> 
    <option value="#BD00FF">Electric Violet (荧光紫/电子紫)</option> 
    
    /* 暖色及经典系列 */
    <option value="#FF7300">Bright Orange (亮橘)</option>
    <option value="#ff6c2f">Bright Red (鲜红)</option>
    <option value="#ffe800">Yellow (黄)</option>
    <option value="#b1905a">Copper / Gold (金属铜金)</option>
    <option value="#6e1e2d">Burgundy (酒红)</option>
    
    /* 冷色及清新系列 */
    <option value="#82d8d5">Mint (薄荷绿)</option>
    <option value="#00a95c">Green (绿)</option>
    <option value="#005d43">Hunter Green (猎人绿)</option>
    <option value="#00838a">Teal (青色)</option>
    <option value="#40c1ff">Sky Blue (天蓝)</option>
    <option value="#6488ea">Cornflower (矢车菊蓝)</option>
    <option value="#0078bf">Risofederal Blue (联邦蓝)</option>
       /* 基础系列 */
    <option value="#000000" selected>Black (黑)</option>
    <option value="#451910" >Choco (巧克力色)</option>
    <option value="#ffffff">White (纯白)</option>
    /* 紫色及复古系列 */
    <option value="#765ba7">Purple (紫色)</option>
    <option value="#665780">Grape (葡萄紫)</option>
    <option value="#d6b4fc">Lavender (浅紫色/熏衣草)</option>
    <option value="#f5a18d">Apricot (杏黄 - 肤色)</option>
<option value="#5f8289">Smoky Teal (烟熏青 - 灰)</option>
<option value="#e5483f">Crimson (深红 - 复古海报)</option>
<option value="#bb8b41">Flat Gold (哑光金 - 绘本风)</option>
    
 
`;

                for (let i = 1; i <= 6; i++) {
                    document.write(`
                    <div class="layer-box ${i > 1 ? 'disabled' : ''}" id="box${i}">
                        <div class="layer-header">
                            <input type="checkbox" id="en${i}" ${i === 1 ? 'checked' : ''}>
                            <span>图层通道 ${i}</span>
                            <select id="m${i}" style="width:auto; margin-left:auto; font-size:10px">
                                <option value="BLEND">智能叠加 (Smart Blend)</option>
                                <option value="MULTIPLY">经典正片叠底</option>
                                <option value="COLOR_BURN">经典颜色加深</option>
                            </select>
                        </div>
                        <div class="ctrl-group">
                            <label>油墨与透明度</label>
                            <div class="slider-row">
                                <select id="c${i}">${risoColors}</select>
                                <input type="range" id="a${i}" min="0" max="255" value="230">
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <label>RYB 逻辑提取 / 网点倍率</label>
                            <div class="slider-row">
                                <select id="ch${i}">
    <optgroup label="艺术分色 (RYB)">
        <option value="art_red">红色 (Red)</option>
        <option value="art_yellow">黄色 (Yellow)</option>
        <option value="art_blue">蓝色 (Blue)</option>
        <option value="art_orange">橙色 (Orange)</option>
        <option value="art_green">绿色 (Green)</option>
        <option value="art_purple">紫色 (Purple)</option>
    </optgroup>
    <optgroup label="印刷分色 (CMYK)">
        <option value="cmyk_c">青色通道 (Cyan)</option>
        <option value="cmyk_m">品色通道 (Magenta)</option>
        <option value="cmyk_y">黄色通道 (Yellow)</option>
        <option value="cmyk_k">黑色通道 (Key/Black)</option>
    </optgroup>
    <optgroup label="光影通道">
        <option value="dark">深色阴影</option>
        <option value="light">浅色亮部</option>
    </optgroup>
</select>
                                <input type="range" id="s${i}" min="0.5" max="3.0" step="0.1" value="1.6">
                            </div>
                        </div>
                        <div class="ctrl-group">
                            <label>容差 & 偏移</label>
                            <div class="slider-row">
                                <input type="range" id="t${i}" min="0" max="200" value="60">
                            </div>
                            <div class="slider-row" style="margin-top:5px">
                                X:<input type="range" id="x${i}" min="-15" max="15" value="0">
                                Y:<input type="range" id="y${i}" min="-15" max="15" value="0">
                            </div>
                        </div>
                    </div>
                `);
                }
            </script>
        </div>
    </div>

    <div class="canvas-area" id="p5-holder"></div>

    <script>
        let img;
        let cachedData = [];
        let imgW = 0, imgH = 0;
        let pg;

        function setup() {
            const cnv = createCanvas(600, 600);
            cnv.parent('p5-holder');
            pg = createGraphics(600, 600);
            document.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', (e) => {
                    if (e.target.id.startsWith('en')) {
                        const id = e.target.id.replace('en', '');
                        document.getElementById('box' + id).classList.toggle('disabled', !e.target.checked);
                    }
                    loop();
                });
            });
            document.getElementById('imgInput').addEventListener('change', handleFile);
            noLoop();
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                loadImage(event.target.result, loadedImg => {
                    if (loadedImg.width > 500) loadedImg.resize(500, 0);
                    img = loadedImg;
                    img.loadPixels();
                    imgW = img.width; imgH = img.height;
                    cachedData = [];
                    for (let i = 0; i < img.pixels.length; i += 4) {
                        cachedData.push({ r: img.pixels[i], g: img.pixels[i + 1], b: img.pixels[i + 2] });
                    }
                    const finalH = 750 * (imgH / imgW);
                    resizeCanvas(750, finalH);
                    pg = createGraphics(750, finalH);
                    loop();
                });
            };
            reader.readAsDataURL(file);
        }

        function draw() {
// 获取用户选择的背景色
    const bgCol = document.getElementById('bgColorIn').value;
    background(bgCol);
            if (!img) return;
            push(); stroke(0, 10);
            for (let i = 0; i < 6000; i++) point(random(width), random(height));
            pop();
            const globalGrid = parseInt(document.getElementById('gridIn').value);
            for (let i = 1; i <= 6; i++) {
                if (document.getElementById('en' + i).checked) renderSmartLayer(i, globalGrid);
            }
            noLoop();
        }

        function renderSmartLayer(idx, dSize) {
            const blendKey = document.getElementById('m' + idx).value;
            const baseCol = color(document.getElementById('c' + idx).value);
            const alphaVal = float(document.getElementById('a' + idx).value);
            pg.clear();
            pg.fill(red(baseCol), green(baseCol), blue(baseCol), alphaVal);
            pg.noStroke();

            const offX = float(document.getElementById('x' + idx).value);
            const offY = float(document.getElementById('y' + idx).value);
            const modeKey = document.getElementById('ch' + idx).value;
            const dotScale = float(document.getElementById('s' + idx).value);
            const tolerance = float(document.getElementById('t' + idx).value);

            for (let y = 0; y < imgH; y++) {
                for (let x = 0; x < imgW; x++) {
                    if (x % Math.floor(dSize / 2) === 0 && y % Math.floor(dSize / 2) === 0) {
                        const p = cachedData[y * imgW + x];
                        let strength = 0;

                        // RYB 艺术家分色算法
                        switch (modeKey) {
                            case 'art_red': strength = p.r - (p.g + p.b) / 2; break;
                            case 'art_yellow': strength = (p.r + p.g) / 2 - p.b; break;
                            case 'art_blue': strength = p.b - (p.r + p.g) / 2; break;
                            case 'art_orange': strength = p.r * 0.8 + p.g * 0.4 - p.b; break;
                            case 'art_green': strength = p.g - (p.r + p.b) / 2; break;
                            case 'art_purple': strength = (p.r + p.b) / 2 - p.g; break;
                            case 'cmyk_c':
                                strength = 255 - p.r;
                                break;
                            case 'cmyk_m':
                                strength = 255 - p.g;
                                break;
                            case 'cmyk_y':
                                strength = 255 - p.b;
                                break;
                            case 'cmyk_k':
                                strength = 255 - max(p.r, max(p.g, p.b));
                                break;
                            case 'dark': strength = 255 - (p.r + p.g + p.b) / 3; break;
                            case 'light': strength = (p.r + p.g + p.b) / 3 - 128; break;
                        }

                        const finalS = map(strength, 0, 255 - tolerance, 0, 255);
                        const radius = map(constrain(finalS, 0, 255), 0, 200, 0, dSize * dotScale);
                        if (radius > 0.4) {
                            pg.ellipse(map(x, 0, imgW, 0, width) + offX, map(y, 0, imgH, 0, height) + offY, radius);
                        }
                    }
                }
            }
// 在 renderLayer 函数末尾的混合逻辑处修改
push();
const isWhite = document.getElementById('c' + idx).value.toLowerCase() === '#ffffff';

if (isWhite) {
    // 如果是白色油墨，使用 SCREEN (滤色) 或 LIGHTEN (变亮) 模式
    // 这样它就能在深色底色上留下“发光”或“漂白”的痕迹
    blendMode(SCREEN); 
    image(pg, 0, 0);
} else if (blendKey === 'BLEND') {
    blendMode(MULTIPLY); 
    image(pg, 0, 0);
} else {
    blendMode(eval(blendKey)); 
    image(pg, 0, 0);
}
pop();
        }
    </script>
</body>

</html>